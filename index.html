<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LiveTV</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
  --header-h:50px;
  --footer-h:30px;
  --bg:#0f1115;
  --panel:#141720;
  --panel2:#181b22;
  --border:#252a34;
  --accent:#4da3ff;
}

/* RESET */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:var(--bg);
  color:#eaeaf0;
  height:100dvh;
  overflow:hidden;
}

/* HEADER */
header{
  height:var(--header-h);
  background:var(--panel);
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}
#netStatus{
  position:absolute;
  right:10px;
  font-size:12px;
  color:#2ecc71;
}
#netStatus.offline{color:#e74c3c}

/* FOOTER */
footer{
  height:var(--footer-h);
  background:var(--panel);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:#9aa0aa;
}

/* MAIN */
main{
  height:calc(100dvh - var(--header-h) - var(--footer-h));
  display:flex;
  flex-direction:column;
}

/* DESKTOP */
@media(min-width:992px){
  main{
    display:grid;
    grid-template-columns:1.6fr 1fr;
  }
}

/* LEFT */
.left{
  display:flex;
  flex-direction:column;
  height:100%;
}

/* PLAYER */
.player-box{
  background:#000;
  position:relative;
  width:100%;
  aspect-ratio:16/9;
}
@media(min-width:992px){
  .player-box{
    aspect-ratio:auto;
    flex:1;
  }
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

/* OVERLAY */
#playerOverlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  pointer-events:none;
}
.spinner{
  width:42px;height:42px;
  border:4px solid rgba(255,255,255,.3);
  border-top:4px solid var(--accent);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
#retryText{margin-top:8px;font-size:13px}

/* TOOLBAR */
.toolbar{
  background:var(--panel2);
  display:flex;
  gap:6px;
  padding:8px;
  flex-wrap:wrap;
}
.toolbar button{
  background:#222735;
  border:1px solid var(--border);
  color:#eaeaf0;
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
.toolbar button.active{
  background:var(--accent);
  color:#000;
}

/* RIGHT */
.right{
  display:flex;
  flex-direction:column;
  height:100%;
  min-height:0;
}

/* FILTERS */
.filters{
  background:var(--panel2);
  display:grid;
  grid-template-columns:1fr .8fr .8fr;
  gap:6px;
  padding:8px;
}
.filters input,.filters select{
  background:var(--bg);
  border:1px solid var(--border);
  color:#eaeaf0;
  padding:6px 8px;
  border-radius:8px;
}

/* LIST */
.table-wrap{
  flex:1;
  overflow-y:auto;
}
table{
  width:100%;
  border-collapse:collapse;
}
thead{
  position:sticky;
  top:0;
  background:var(--panel);
}
th,td{
  padding:8px;
  border-bottom:1px solid var(--border);
  font-size:14px;
}
tr{height:52px}
tr:hover{background:#222735;cursor:pointer}
tr.playing{background:#1f3b5c}

/* CELLS */
.logo{
  width:36px;height:36px;
  object-fit:contain;
  background:#000;
  border-radius:6px;
}
.star{color:#f1c40f}
.dot{
  width:10px;height:10px;
  border-radius:50%;
  display:inline-block;
}
.green{background:#2ecc71}
.red{background:#e74c3c}
</style>
</head>

<body>

<header>
  üì∫ LiveTV
  <span id="netStatus">‚óè Online</span>
</header>

<main>

<section class="left">
  <div class="player-box">
    <video id="video" controls playsinline></video>
    <div id="playerOverlay">
      <div class="spinner"></div>
      <div id="retryText">Reconnecting‚Ä¶</div>
    </div>
  </div>

  <div class="toolbar">
    <button id="favBtn">‚≠ê Favourite</button>
    <button id="reloadBtn">üîÑ Reload</button>
    <button id="favOnlyBtn">‚≠ê Only</button>
    <div id="qualities" style="display:flex;gap:6px"></div>
  </div>
</section>

<section class="right">

  <div class="filters">
    <input id="search" placeholder="üîç Search">
    <select id="country"></select>
    <select id="category"></select>
  </div>

  <div class="table-wrap" id="scrollBox">
    <table>
      <thead>
        <tr>
          <th></th>
          <th>Logo</th>
          <th>Category</th>
          <th>Channel</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="grid"></tbody>
    </table>
  </div>

</section>
</main>

<footer>No streams are hosted ‚Ä¢ iptv-org</footer>

<script>
/* ===== CONFIG ===== */
const DATA="data/channels.json";
const PAGE_SIZE=30;
const MAX_RETRY=3;

/* ===== STATE ===== */
let channels=[], filtered=[], page=1;
let current=null,currentUrl=null,hls;
let retryCount=0,qualityList=[],qIndex=0;
let favOnly=false,isLoading=false;

const favs=new Set(JSON.parse(localStorage.getItem("favs")||"[]"));

/* ===== ELEMENTS ===== */
const video=document.getElementById("video");
const grid=document.getElementById("grid");
const scrollBox=document.getElementById("scrollBox");
const qualities=document.getElementById("qualities");
const overlay=document.getElementById("playerOverlay");
const retryText=document.getElementById("retryText");

const search=document.getElementById("search");
const country=document.getElementById("country");
const category=document.getElementById("category");
const favBtn=document.getElementById("favBtn");
const favOnlyBtn=document.getElementById("favOnlyBtn");
const reloadBtn=document.getElementById("reloadBtn");

/* ===== NETWORK ===== */
const net=document.getElementById("netStatus");
function netUpdate(){
  if(navigator.onLine){
    net.textContent="‚óè Online";
    net.classList.remove("offline");
  }else{
    net.textContent="‚óè Offline";
    net.classList.add("offline");
    overlay.style.display="flex";
  }
}
window.addEventListener("online",netUpdate);
window.addEventListener("offline",netUpdate);
netUpdate();

/* ===== HELPERS ===== */
const qOf=n=>(n.match(/(\d{3,4})p/i)||[])[1]||"Auto";

/* ===== LOAD DATA ===== */
fetch(DATA).then(r=>r.json()).then(d=>{
  channels=d.map(c=>({
    name:c.n||"",
    url:c.u||"",
    logo:c.l||"",
    category:c.g||"",
    country:c.c||"International",
    active:!!c.u
  }));
  buildFilters();
  applyFilters();
});

/* ===== FILTERS ===== */
function buildFilters(){
  country.innerHTML='<option>All</option>'+[...new Set(channels.map(c=>c.country))].sort().map(c=>`<option>${c}</option>`).join("");
  category.innerHTML='<option>All</option>'+[...new Set(channels.flatMap(c=>c.category.split(";")))].sort().map(c=>`<option>${c}</option>`).join("");
}

function applyFilters(){
  page=1;
  grid.innerHTML="";
  filtered=channels.filter(c=>{
    if(favOnly && !favs.has(c.name)) return false;
    if(search.value && !c.name.toLowerCase().includes(search.value.toLowerCase())) return false;
    if(country.value!=="All" && c.country!==country.value) return false;
    if(category.value!=="All" && !c.category.includes(category.value)) return false;
    return true;
  });
  renderPage();
}

/* ===== RENDER ===== */
function renderPage(){
  if(isLoading) return;
  isLoading=true;

  const start=(page-1)*PAGE_SIZE;
  const end=start+PAGE_SIZE;

  const frag=document.createDocumentFragment();

  filtered.slice(start,end).forEach(c=>{
    const tr=document.createElement("tr");
    if(c.name===current) tr.classList.add("playing");
    tr.innerHTML=`
      <td>${favs.has(c.name)?"<span class='star'>‚òÖ</span>":""}</td>
      <td><img class="logo" src="${c.logo}"></td>
      <td>${c.category.split(";")[0]||"-"}</td>
      <td>${c.name}</td>
      <td><span class="dot ${c.active?'green':'red'}"></span></td>
    `;
    tr.onclick=()=>play(c.name);
    frag.appendChild(tr);
  });

  grid.appendChild(frag);
  isLoading=false;
}

/* ===== SCROLL ===== */
scrollBox.addEventListener("scroll",()=>{
  const nearBottom=scrollBox.scrollTop+scrollBox.clientHeight>=scrollBox.scrollHeight-50;
  if(nearBottom && page*PAGE_SIZE<filtered.length){
    page++;
    renderPage();
  }
});

/* ===== PLAYER ===== */
function play(name){
  current=name;
  retryCount=0;
  qualityList=channels.filter(c=>c.name===name && c.url);
  qIndex=0;
  qualities.innerHTML="";
  qualityList.forEach((c,i)=>{
    const b=document.createElement("button");
    b.textContent=qOf(c.name);
    if(i===0)b.classList.add("active");
    b.onclick=()=>{qIndex=i;retryCount=0;switchQuality(c.url,b)};
    qualities.appendChild(b);
  });
  switchQuality(qualityList[0].url,qualities.firstChild);
  highlight();
}

function switchQuality(url,btn){
  currentUrl=url;
  [...qualities.children].forEach(b=>b.classList.remove("active"));
  if(btn)btn.classList.add("active");
  if(hls){hls.destroy();hls=null}
  if(Hls.isSupported()){
    hls=new Hls();
    hls.on(Hls.Events.ERROR,(e,d)=>{
      if(!d.fatal) return;
      if(retryCount<MAX_RETRY){
        retryCount++;
        overlay.style.display="flex";
        retryText.textContent=`Reconnecting‚Ä¶ (${retryCount}/${MAX_RETRY})`;
        setTimeout(()=>switchQuality(currentUrl,qualities.children[qIndex]),2000);
        return;
      }
    });
    hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play().catch(()=>{}));
    hls.loadSource(url);
    hls.attachMedia(video);
  }else video.src=url;
  video.play().catch(()=>{});
}

video.addEventListener("playing",()=>overlay.style.display="none");

/* ===== UI ===== */
function highlight(){
  [...grid.children].forEach(r=>r.classList.remove("playing"));
  [...grid.children].forEach(r=>{
    if(r.children[3].textContent===current) r.classList.add("playing");
  });
}

reloadBtn.onclick=()=>currentUrl&&switchQuality(currentUrl,qualities.children[qIndex]);
favBtn.onclick=()=>{
  if(!current)return;
  favs.has(current)?favs.delete(current):favs.add(current);
  localStorage.setItem("favs",JSON.stringify([...favs]));
  applyFilters();
};
favOnlyBtn.onclick=()=>{
  favOnly=!favOnly;
  favOnlyBtn.classList.toggle("active");
  applyFilters();
};

search.oninput=applyFilters;
country.onchange=applyFilters;
category.onchange=applyFilters;
</script>

</body>
</html>
