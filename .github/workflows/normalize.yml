name: Normalize & Optimize IPTV JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"

jobs:
  normalize:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Normalize & optimize
        run: |
          python3 << 'EOF'
          import json
          with open("data/channels.json","r",encoding="utf-8") as f:
              data=json.load(f)

          optimized=[]
          for c in data:
              optimized.append({
                "n": c.get("name"),
                "u": c.get("url"),
                "l": c.get("logo"),
                "c": c.get("country") if c.get("country") else "International",
                "g": c.get("category")
              })

          with open("data/channels.min.json","w",encoding="utf-8") as f:
              json.dump(optimized,f,separators=(',',':'))

          print("Optimized:",len(optimized))
          EOF

      - name: Commit channels.min.json
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add data/channels.min.json
          git commit -m "Normalize & optimize IPTV channels" || echo "No changes"
          git push
