name: Sync IPTV Channels (BD)

on:
  schedule:
    - cron: "0 22 * * *" # 04:00 AM BST (UTC+6)
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Generate channels.json
        run: |
          python - << 'EOF'
          import requests, json, re
          from datetime import datetime

          M3U_URL = "https://iptv-org.github.io/iptv/countries/bd.m3u"
          TIMEOUT = 6

          def works(url):
              try:
                  r = requests.get(url, timeout=TIMEOUT, stream=True)
                  return r.status_code == 200
              except:
                  return False

          text = requests.get(M3U_URL, timeout=10).text.splitlines()

          channels = []
          name, logo = None, ""

          for line in text:
              if line.startswith("#EXTINF"):
                  name = re.search(r",(.+)", line).group(1)
                  m = re.search(r'tvg-logo="(.*?)"', line)
                  logo = m.group(1) if m else ""
              elif line.startswith("http"):
                  if works(line):
                      channels.append({
                          "name": name,
                          "url": line,
                          "logo": logo
                      })

          data = {
              "country": "Bangladesh",
              "updated_at": datetime.utcnow().isoformat(),
              "count": len(channels),
              "channels": channels
          }

          with open("data/channels.json", "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2, ensure_ascii=False)

          print("Saved", len(channels), "channels")
          EOF

      - name: Commit & push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add data/channels.json
          git commit -m "Auto sync IPTV channels" || exit 0
          git push
