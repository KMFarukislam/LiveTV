name: IPTV Auto Sync

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download IPTV playlist
        run: curl -L https://iptv-org.github.io/iptv/index.m3u -o index.m3u

      - name: Convert M3U to JSON
        run: |
          python3 << 'EOF'
          import json, re

          channels = []
          current = {}

          with open("index.m3u", encoding="utf-8", errors="ignore") as f:
              for line in f:
                  line = line.strip()
                  if line.startswith("#EXTINF"):
                      def g(p):
                          m = re.search(p, line)
                          return m.group(1) if m else ""
                      current = {
                          "name": g('tvg-name="([^"]*)"') or g(',([^,]+)$'),
                          "country": g('tvg-country="([^"]*)"') or "International",
                          "category": g('group-title="([^"]*)"') or "Other",
                          "logo": g('tvg-logo="([^"]*)"'),
                          "url": ""
                      }
                  elif line and not line.startswith("#"):
                      current["url"] = line
                      channels.append(current)

          with open("data/channels.json", "w", encoding="utf-8") as out:
              json.dump(channels, out, ensure_ascii=False)

          print("Channels synced:", len(channels))
          EOF

      - name: Commit updated channels
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/channels.json
          git commit -m "Auto sync IPTV channels" || echo "No changes"
          git push
