name: Bangladesh IPTV Auto Sync

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download IPTV channels
        run: |
          curl -L --fail \
          https://iptv-org.github.io/iptv/channels.json \
          -o channels.json

      - name: Validate JSON file
        run: |
          test -s channels.json || (echo "channels.json is empty" && exit 1)
          python3 - << 'EOF'
          import json
          with open("channels.json", encoding="utf-8") as f:
              json.load(f)
          print("JSON is valid")
          EOF

      - name: Filter Bangladesh channels
        run: |
          python3 << 'EOF'
          import json, os

          with open("channels.json", encoding="utf-8") as f:
              data = json.load(f)

          bd_keywords = [
              "bangla","বাংলা","btv","channel i","atn",
              "ntv","independent","somoy","jamuna",
              "ekattor","rtv","maasranga","gazi"
          ]

          bd = []
          for c in data:
              name = (c.get("name") or "").lower()
              country = c.get("country") or ""

              if country == "Bangladesh" or any(k in name for k in bd_keywords):
                  bd.append({
                      "name": c.get("name"),
                      "url": c.get("url"),
                      "logo": c.get("logo"),
                      "category": c.get("category") or "General",
                      "source": "iptv"
                  })

          os.makedirs("data", exist_ok=True)
          with open("data/channels-bd.json","w",encoding="utf-8") as out:
              json.dump(bd,out,ensure_ascii=False,indent=2)

          print("Bangladesh channels:",len(bd))
          EOF

      - name: Commit update
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/channels-bd.json
          git commit -m "Auto sync Bangladesh IPTV channels" || echo "No changes"
          git push
