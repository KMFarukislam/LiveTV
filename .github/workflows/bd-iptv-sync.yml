name: Bangladesh IPTV Auto Sync

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download iptv-org data
        run: |
          curl -L --fail https://iptv-org.github.io/api/channels.json -o channels.json
          curl -L --fail https://iptv-org.github.io/api/streams.json -o streams.json

      - name: Build Bangladesh playable channels
        run: |
          python3 << 'EOF'
          import json, os

          with open("channels.json", encoding="utf-8") as f:
              channels = json.load(f)

          with open("streams.json", encoding="utf-8") as f:
              streams = json.load(f)

          # index streams by channel id
          stream_map = {}
          for s in streams:
              cid = s.get("channel")
              url = s.get("url")
              if cid and url:
                  stream_map.setdefault(cid, []).append(url)

          bd_keywords = [
              "bangla","বাংলা","btv","channel i","atn",
              "ntv","independent","somoy","jamuna",
              "ekattor","rtv","maasranga","gazi"
          ]

          result = []

          for c in channels:
              cid = c.get("id")
              name = (c.get("name") or "").lower()
              country = c.get("country") or ""

              if country == "Bangladesh" or any(k in name for k in bd_keywords):
                  urls = stream_map.get(cid, [])
                  if not urls:
                      continue   # ❗ skip unplayable channels

                  result.append({
                      "id": cid,
                      "name": c.get("name"),
                      "logo": c.get("logo"),
                      "category": (c.get("categories") or ["General"])[0],
                      "streams": urls,
                      "source": "iptv-org"
                  })

          os.makedirs("data", exist_ok=True)
          with open("data/channels-bd.json","w",encoding="utf-8") as out:
              json.dump(result,out,ensure_ascii=False,indent=2)

          print("Playable Bangladesh channels:", len(result))
          EOF

      - name: Commit update
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/channels-bd.json
          git commit -m "Sync playable Bangladesh IPTV channels" || echo "No changes"
          git push
